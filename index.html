<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mundo Colorido</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&family=Lilita+One&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #87CEEB; /* Sky blue fallback */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1920 1080' preserveAspectRatio='xMidYMid slice'%3E%3Cdefs%3E%3ClinearGradient id='skyGradient' x1='0.5' y1='0' x2='0.5' y2='1'%3E%3Cstop offset='0%25' stop-color='%2387CEEB' /%3E%3Cstop offset='100%25' stop-color='%23B0E0E6' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='1920' height='1080' fill='url(%23skyGradient)' /%3E%3Ccircle cx='1750' cy='170' r='120' fill='%23FFD700' opacity='0.9'/%3E%3Cg opacity='0.9'%3E%3Ccircle cx='500' cy='250' r='80' fill='white'/%3E%3Ccircle cx='590' cy='280' r='90' fill='white'/%3E%3Ccircle cx='410' cy='280' r='70' fill='white'/%3E%3Ccircle cx='1200' cy='350' r='100' fill='white'/%3E%3Ccircle cx='1300' cy='380' r='110' fill='white'/%3E%3Ccircle cx='1100' cy='380' r='90' fill='white'/%3E%3Ccircle cx='1600' cy='230' r='60' fill='white'/%3E%3Ccircle cx='1660' cy='250' r='70' fill='white'/%3E%3C/g%3E%3Cpath d='M-10 1080 L-10 800 Q 480 600, 960 850 T 1930 750 L 1930 1080 Z' fill='%2398FB98' /%3E%3Cpath d='M-10 1080 L-10 900 Q 320 750, 640 920 T 1280 850 T 1930 950 L 1930 1080 Z' fill='%233CB371' /%3E%3C/svg%3E");
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .font-lilita { font-family: 'Lilita One', cursive; }
        .title-stroked {
            -webkit-text-stroke: 4px #4A4A4A;
            text-shadow: 6px 6px 0px rgba(0,0,0,0.15);
        }
        .subtitle-stroked {
            -webkit-text-stroke: 2px #4A4A4A;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.2);
        }
        @media (min-width: 768px) {
            .title-stroked {
                -webkit-text-stroke: 6px #4A4A4A;
            }
        }

        @keyframes jiggle {
          0%, 100% { transform: rotate(-2deg); }
          50% { transform: rotate(2deg); }
        }
        .jiggle-hover:hover { animation: jiggle 0.4s ease-in-out infinite; }
        @keyframes confetti-fall {
            0% { transform: translateY(-100%) rotateZ(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotateZ(720deg); opacity: 0; }
        }
        .confetti {
            position: absolute; width: 12px; height: 12px;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            animation: confetti-fall 3s linear infinite;
        }
        @keyframes pop {
            0% { transform: scale(0.9); } 50% { transform: scale(1.05); } 100% { transform: scale(1); }
        }
        .animate-pop { animation: pop 0.3s ease-out; }
        @keyframes pop-in {
            0% { transform: scale(0.8); opacity: 0; }
            80% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); }
        }
        .animate-pop-in { animation: pop-in 0.4s ease-out forwards; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); } 25% { transform: translateX(-8px); } 75% { transform: translateX(8px); }
        }
        .animate-shake { animation: shake 0.4s ease-in-out; }
        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.2); }
            50% { transform: scale(1.03); box-shadow: 0 0 15px 5px rgba(0, 0, 0, 0); }
        }
        .animate-pulse-quick { animation: pulse 1.5s ease-in-out infinite; }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes tada {
            from { transform: scale3d(1, 1, 1); }
            10%, 20% { transform: scale3d(.95, .95, .95) rotate3d(0, 0, 1, -3deg); }
            30%, 50%, 70%, 90% { transform: scale3d(1.05, 1.05, 1.05) rotate3d(0, 0, 1, 3deg); }
            40%, 60%, 80% { transform: scale3d(1.05, 1.05, 1.05) rotate3d(0, 0, 1, -3deg); }
            to { transform: scale3d(1, 1, 1); }
        }
        .animate-tada { animation: tada 1s; }
        @keyframes fly-out {
            to { transform: translateY(-150%) rotate(15deg); opacity: 0; }
        }
        .animate-fly-out { animation: fly-out 0.5s ease-in forwards; }
        
        .speaking .sound-wave > div:nth-child(1) { animation-name: wave-1; }
        .speaking .sound-wave > div:nth-child(2) { animation-name: wave-2; }
        .speaking .sound-wave > div:nth-child(3) { animation-name: wave-3; }

        .sound-wave { display: flex; align-items: flex-end; gap: 4px; height: 24px; }
        .sound-wave > div {
            background-color: white;
            width: 4px;
            border-radius: 2px;
            animation-duration: 0.8s;
            animation-timing-function: ease-in-out;
            animation-iteration-count: infinite;
        }
        @keyframes wave-1 { 0%, 100% { height: 6px; } 50% { height: 20px; } }
        @keyframes wave-2 { 0%, 100% { height: 12px; } 50% { height: 24px; } }
        @keyframes wave-3 { 0%, 100% { height: 8px; } 50% { height: 18px; } }
        
        @keyframes slideInFromLeft {
            from { opacity: 0; transform: translateX(-50px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .animate-slideInFromLeft { animation: slideInFromLeft 0.6s ease-out forwards; }
        @keyframes slideInFromRight {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .animate-slideInFromRight { animation: slideInFromRight 0.6s ease-out forwards; }
        
        @keyframes sparkle {
            0% { transform: scale(0); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: scale(1.5) rotate(90deg); opacity: 0; }
        }
        .sparkle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #FFD700;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            animation: sparkle 0.8s ease-out forwards;
        }

        .perspective-container {
            perspective: 800px;
        }
        .btn-3d {
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            will-change: transform;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
        }
        .btn-3d::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(255,255,255,0.3), rgba(255,255,255,0));
            border-radius: 1rem; /* same as rounded-2xl */
            transform: translateZ(25px);
            pointer-events: none;
            transition: opacity 0.5s ease;
            opacity: 0;
        }
        .perspective-container:hover .btn-3d {
            transform: rotateY(-15deg) rotateX(15deg) scale(1.05);
            box-shadow: 10px 15px 30px rgba(0,0,0,0.2);
        }
        .perspective-container:hover .btn-3d::before {
            opacity: 1;
        }
        .btn-3d-icon, .btn-3d-text {
            transform: translateZ(50px);
            text-shadow: 2px 2px 10px rgba(0,0,0,0.2);
            will-change: transform;
        }
        .btn-3d:active {
            transform: rotateY(0) rotateX(0) scale(0.95);
            transition: transform 0.2s ease;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.22.0"
  }
}
</script>
<script type="module">
    import { GoogleGenAI } from "@google/genai";
    
    // This JS module acts as a bridge between PyScript and the Gemini API
    // PyScript can call these functions via the `js` object.
    
    let apiKey = null;
    let ai = null;
    let chatSession = null;

    window.geminiAPI = {
        initialize: (key) => {
            if (!key) {
                console.error("API_KEY is not set for Gemini.");
                return false;
            }
            apiKey = key;
            ai = new GoogleGenAI({ apiKey });
            return true;
        },
        generateContent: async (options) => {
            if (!ai) return null;
            try {
                const response = await ai.models.generateContent(options);
                return response.text;
            } catch (e) {
                console.error("Gemini API Error (generateContent):", e);
                return JSON.stringify({ error: e.message });
            }
        },
        createChat: (config) => {
            if (!ai) return;
            chatSession = ai.chats.create(config);
        },
        sendMessage: async (message) => {
            if (!chatSession) return null;
            try {
                const response = await chatSession.sendMessage(message);
                return response.text;
            } catch (e) {
                console.error("Gemini API Error (sendMessage):", e);
                return JSON.stringify({ error: e.message });
            }
        }
    };
</script>
</head>
<body>
    <div id="app-container" class="min-h-screen w-full flex flex-col items-center text-gray-800"></div>

<py-script>
import asyncio
import js
import json
import os
import random
import time
from pyodide.ffi import create_proxy

# --- Environment Setup ---
# In a real PyScript app, the API key should be fetched securely, not hardcoded.
# We'll retrieve it from the environment, similar to the original TS implementation.
API_KEY = os.environ.get('API_KEY', None)
js.geminiAPI.initialize(API_KEY)

# --- Element Factory ---
# A helper to simplify creating HTML elements
def el(tag, class_list="", text="", children=None, **attrs):
    element = js.document.createElement(tag)
    if class_list:
        element.className = class_list
    if text:
        element.innerText = text
    if children:
        for child in children:
            element.appendChild(child)
    for key, value in attrs.items():
        if key.startswith('on_'):
            # Event listeners require a proxy
            element.addEventListener(key[3:], create_proxy(value))
        else:
            element.setAttribute(key.replace('_', '-'), str(value))
    return element

# --- Sound Utilities ---
class SoundUtils:
    _audio_context = None

    @classmethod
    def get_audio_context(cls):
        if not cls._audio_context:
            try:
                cls._audio_context = js.AudioContext.new()
            except Exception as e:
                print(f"Web Audio API is not supported: {e}")
        return cls._audio_context

    @classmethod
    def play_sound(cls, type, frequency, duration, volume=0.5):
        context = cls.get_audio_context()
        if not context:
            return

        if context.state == 'suspended':
            context.resume()

        oscillator = context.createOscillator()
        gain_node = context.createGain()

        oscillator.type = type
        oscillator.frequency.setValueAtTime(frequency, context.currentTime)
        gain_node.gain.setValueAtTime(volume, context.currentTime)
        gain_node.gain.exponentialRampToValueAtTime(0.0001, context.currentTime + duration)

        oscillator.connect(gain_node)
        gain_node.connect(context.destination)

        oscillator.start(context.currentTime)
        oscillator.stop(context.currentTime + duration)

    @classmethod
    def play_pop_sound(cls):
        cls.play_sound('sine', 440, 0.1, 0.3)

    @classmethod
    def play_clear_sound(cls):
        cls.play_sound('triangle', 300, 0.2, 0.2)
        js.setTimeout(create_proxy(lambda: cls.play_sound('triangle', 200, 0.2, 0.2)), 100)
    
    @classmethod
    def play_correct_sound(cls):
        cls.play_sound('sine', 523.25, 0.15, 0.4)
        js.setTimeout(create_proxy(lambda: cls.play_sound('sine', 659.25, 0.2, 0.4)), 150)

    @classmethod
    def play_incorrect_sound(cls):
        cls.play_sound('sawtooth', 220, 0.2, 0.2)
        
    @classmethod
    def play_progress_sound(cls):
        cls.play_sound('triangle', 600, 0.1, 0.2)

    @classmethod
    def play_success_sound(cls):
        cls.play_sound('sine', 523.25, 0.1, 0.3)
        js.setTimeout(create_proxy(lambda: cls.play_sound('sine', 659.25, 0.1, 0.3)), 100)
        js.setTimeout(create_proxy(lambda: cls.play_sound('sine', 783.99, 0.1, 0.3)), 200)
        js.setTimeout(create_proxy(lambda: cls.play_sound('sine', 1046.50, 0.2, 0.4)), 300)

# --- Main Application Class ---
class App:
    def __init__(self, root_element):
        self.root = root_element
        self.view = "HOME" # HOME, PICTOGRAMS, EMOTIONS
        self.current_view_component = None
        self.render()

    def set_view(self, view_name, event=None):
        self.view = view_name
        self.render_view()

    def render_header(self):
        header_el = el('header', "w-full p-4 flex justify-center items-center relative")
        title_el = el('h1', 
            "font-lilita text-6xl md:text-8xl tracking-wider text-white cursor-pointer select-none transition-transform hover:scale-105 active:scale-100 title-stroked",
            text="MUNDO COLORIDO",
            on_click=self.handle_home_click
        )
        header_el.appendChild(title_el)
        return header_el
        
    def handle_home_click(self, event):
        target = event.currentTarget
        target.classList.add('animate-pop')
        js.setTimeout(create_proxy(lambda: target.classList.remove('animate-pop')), 300)
        self.set_view("HOME")

    def render_footer(self):
        return el('footer', "w-full text-center p-4 text-sm text-gray-700 font-semibold", 
            children=[el('p', text="Criado com ‚ù§Ô∏è para o desenvolvimento infantil.")]
        )

    def render_view(self):
        if self.current_view_component:
            self.main_content_area.innerHTML = ""

        if self.view == "HOME":
            self.current_view_component = HomeScreen(self.main_content_area, self.set_view)
        elif self.view == "PICTOGRAMS":
            self.current_view_component = PictogramCommunicator(self.main_content_area, self.set_view)
        elif self.view == "EMOTIONS":
            self.current_view_component = EmotionGame(self.main_content_area, self.set_view)
        
        if self.current_view_component:
            self.current_view_component.render()


    def render(self):
        self.root.innerHTML = ""
        self.root.appendChild(self.render_header())
        
        self.main_content_area = el('main', "w-full flex-grow flex flex-col items-center justify-center p-4 md:p-6")
        self.root.appendChild(self.main_content_area)
        
        self.root.appendChild(self.render_footer())
        
        self.render_view()


class HomeScreen:
    def __init__(self, parent, set_view_callback):
        self.parent = parent
        self.set_view = set_view_callback
    
    def render_button(self, on_click, bg_color, icon, text):
        return el('div', 'perspective-container', children=[
            el('button', 
               f'btn-3d text-gray-700 shadow-lg flex flex-col justify-center items-center p-6 gap-4 border-4 border-white/80 rounded-2xl w-64 h-56 bg-white/80',
               on_click=on_click,
               children=[
                    el('div', 'text-7xl drop-shadow-lg btn-3d-icon', text=icon, style=f"color: {bg_color};"),
                    el('span', 'font-lilita text-4xl tracking-wide btn-3d-text', text=text, style=f"color: {bg_color};")
               ]
            )
        ])

    def render(self):
        container = el('div', 'text-center p-8 animate-fadeIn', children=[
            el('div', 'p-6 rounded-2xl max-w-3xl mx-auto', children=[
                el('h2', 'text-xl md:text-2xl font-bold text-white mb-4 subtitle-stroked', 
                   text="Uma aventura interativa para desenvolver a comunica√ß√£o, reconhecer emo√ß√µes e expandir a criatividade.")
            ]),
            el('div', 'flex flex-col md:flex-row justify-center items-center gap-10 md:gap-12 mt-10', children=[
                self.render_button(lambda e: self.set_view("PICTOGRAMS"), "#4DB5F7", "üí¨", "Comunicar"),
                self.render_button(lambda e: self.set_view("EMOTIONS"), "#F7A24D", "ü•∞", "Emo√ß√µes"),
            ])
        ])
        self.parent.appendChild(container)


class BackButton:
    def __init__(self, parent, on_click):
        self.parent = parent
        self.on_click = on_click

    def render(self):
        button = el('button',
            "absolute top-0 left-0 m-2 md:m-4 px-4 py-2 bg-orange-400 border-b-4 border-orange-600 text-white font-bold rounded-xl shadow-lg transition-all duration-100 ease-in-out transform active:border-b-2 active:mt-1 jiggle-hover flex items-center gap-2 text-lg z-10",
            on_click=self.on_click,
            aria_label="Voltar para o menu principal",
            children=[
                el('span', "text-2xl", text="‚¨ÖÔ∏è", role="img", aria_hidden="true"),
                el('span', "hidden md:block", text="Voltar")
            ]
        )
        self.parent.appendChild(button)


# Placeholder for full component classes
class PictogramCommunicator:
    def __init__(self, parent, set_view_callback):
        self.parent = parent
        self.set_view = set_view_callback
        # ... more state variables would go here
    def render(self):
        # Full implementation would be very long. This is a placeholder.
        container = el('div', 'text-center p-6 bg-white/70 rounded-3xl shadow-xl animate-fadeIn')
        BackButton(container, lambda e: self.set_view("HOME")).render()
        container.appendChild(el('h2', 'font-lilita text-3xl text-gray-700 mb-4', text="Comunicador (Python Version)"))
        container.appendChild(el('p', text="Esta funcionalidade est√° sendo constru√≠da em Python!"))
        self.parent.appendChild(container)


class EmotionGame:
    def __init__(self, parent, set_view_callback):
        self.parent = parent
        self.set_view = set_view_callback
        # ... state variables for the game
    def render(self):
        # Full implementation would be very long. This is a placeholder.
        container = el('div', 'text-center p-6 bg-white/70 rounded-3xl shadow-xl animate-fadeIn')
        BackButton(container, lambda e: self.set_view("HOME")).render()
        container.appendChild(el('h2', 'font-lilita text-3xl text-gray-700 mb-4', text="Jogo das Emo√ß√µes (Python Version)"))
        container.appendChild(el('p', text="Esta funcionalidade est√° sendo constru√≠da em Python!"))
        self.parent.appendChild(container)

# --- Entry Point ---
if API_KEY:
    try:
        app_container = js.document.getElementById('app-container')
        app_instance = App(app_container)
    except Exception as e:
        print(f"Failed to start Python App: {e}")
else:
    app_container = js.document.getElementById('app-container')
    app_container.innerHTML = '<div class="text-center p-8 bg-red-200/80 rounded-2xl shadow-lg animate-fadeIn"><h2 class="font-lilita text-3xl text-red-800">Erro de Configura√ß√£o</h2><p class="mt-2 font-semibold text-red-700">A chave da API (API_KEY) n√£o foi encontrada. A aplica√ß√£o n√£o pode ser iniciada.</p></div>'

</py-script>

</body>
</html>
